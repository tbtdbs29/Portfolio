<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistant IA | Thibault</title>
    <link rel="stylesheet" href="../css/style.css"> </head>
<body class="chat-mode">
    
    <div class="noise-overlay"></div>
    <div id="cursor"></div>

    <header class="chat-header">
        <a href="../index.html" class="back-link hover-trigger">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
            Retour
        </a>
        <div class="ai-identity">
            <div class="status-indicator">
                <span class="status-dot"></span>
                <span>SYSTEM ONLINE</span>
            </div>
        </div>
        <div style="width: 60px;"></div> </header>

    <main class="chat-viewport" id="chat">
        <div class="chat-content" id="chatContent">
            
            <div class="message-row bot">
                <div class="avatar">
                    <svg viewBox="0 0 24 24"><path d="M12 2a10 10 0 0 1 10 10c0 5.52-4.48 10-10 10S2 17.52 2 12 6.48 2 12 2zm0 2a8 8 0 0 0-8 8c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8zm0 4a4 4 0 0 1 4 4c0 2.21-1.79 4-4 4s-4-1.79-4-4 1.79-4 4-4z" fill="currentColor"/></svg>
                </div>
                <div class="bubble">
                    <strong>IA :</strong> Initialisation terminée.<br> Je suis l'assistant neural de Thibault. J'ai accès à l'ensemble de son parcours, ses données techniques et ses projets. Quelle information recherchez-vous ?
                </div>
            </div>

        </div>
    </main>

    <div class="input-area-float">
        <div class="input-glass">
            <input type="text" id="userInput" placeholder="Posez une question..." autocomplete="off">
            <button id="sendBtn" class="send-btn hover-trigger">
                <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
            </button>
        </div>
    </div>

    <script>
        // --- LOGIQUE UI ---
        const cursor = document.getElementById('cursor');
        const chatContent = document.getElementById("chatContent");
        const chatViewport = document.getElementById("chat"); // Pour le scroll
        const input = document.getElementById("userInput");
        const sendBtn = document.getElementById("sendBtn");

        // Curseur Magnétique
        document.addEventListener('mousemove', (e) => {
            cursor.style.left = e.clientX + 'px';
            cursor.style.top = e.clientY + 'px';
        });

        // Gestion du hover dynamique
        document.body.addEventListener('mouseover', (e) => {
            if (e.target.closest('.hover-trigger') || e.target.tagName === 'A' || e.target.tagName === 'BUTTON') {
                cursor.classList.add('hovered');
            } else {
                cursor.classList.remove('hovered');
            }
        });

        // --- FONCTIONS CHAT ---

        function createMessageElement(text, sender) {
            const row = document.createElement("div");
            row.classList.add("message-row", sender);

            // Avatar logic
            let avatarHTML = '';
            if (sender === 'bot') {
                avatarHTML = `<div class="avatar"><svg viewBox="0 0 24 24"><path d="M12 2a10 10 0 0 1 10 10c0 5.52-4.48 10-10 10S2 17.52 2 12 6.48 2 12 2zm0 2a8 8 0 0 0-8 8c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8zm0 4a4 4 0 0 1 4 4c0 2.21-1.79 4-4 4s-4-1.79-4-4 1.79-4 4-4z" fill="currentColor"/></svg></div>`;
            }

            // Bubble content
            let contentHTML = `<div class="bubble">${text}</div>`;
            if (sender === 'bot') {
                // Style différent pour le bot, peut inclure du HTML/Markdown plus tard
                contentHTML = `<div class="bubble">${text}</div>`;
            }

            row.innerHTML = sender === 'bot' ? avatarHTML + contentHTML : contentHTML;
            return row;
        }

        function scrollToBottom() {
            chatViewport.scrollTop = chatViewport.scrollHeight;
        }

        async function sendMessage() {
            const text = input.value.trim();
            if (!text) return;

            // 1. Affiche le message de l'utilisateur
            chatContent.appendChild(createMessageElement(text, "user"));
            input.value = "";
            scrollToBottom();
            
            // 2. Affiche le loader stylé
            const loadingId = 'loading-' + Date.now();
            const loadingRow = createMessageElement('<span style="opacity:0.6; font-style:italic;">Analyse en cours...</span>', "bot");
            loadingRow.id = loadingId;
            chatContent.appendChild(loadingRow);
            scrollToBottom();

            try {
                const response = await fetch("/api/chat", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ message: text })
                });
                
                const data = await response.json();
                
                // 3. On supprime le loader
                const loader = document.getElementById(loadingId);
                if(loader) loader.remove();

                // 4. On affiche la vraie réponse du backend
                chatContent.appendChild(createMessageElement(data.reply, "bot"));
                scrollToBottom();

            } catch (err) {
                // Gestion d'erreur
                const loader = document.getElementById(loadingId);
                if(loader) loader.remove();
                
                chatContent.appendChild(createMessageElement("Erreur critique: Je n'arrive pas à joindre le backend (port 3000).", "bot"));
                console.error(err);
            }
        }

        sendBtn.addEventListener("click", sendMessage);
        input.addEventListener("keypress", (e) => {
            if (e.key === "Enter") sendMessage();
        });
        
        // Focus auto
        input.focus();
    </script>
</body>
</html>