<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thibault - Galerie Automatique</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Raleway:wght@300;400&display=swap" rel="stylesheet">
    <style>
        :root {
            --accent-color: #D4AF37;
            --background-color: #0A0A0A;
            --text-color: #EAEAEA;
            --font-title: 'Playfair Display', serif;
            --font-body: 'Raleway', sans-serif;
            --v-transition: 1.2s;
            --h-transition: 1s;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: var(--background-color); color: var(--text-color); font-family: var(--font-body); overflow: hidden; }

        /* --- ÉCRAN DE CHARGEMENT --- */
        #loader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #050505; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.8s ease-out, visibility 0.8s;
        }
        .loader-spinner {
            width: 50px; height: 50px; border: 3px solid rgba(212, 175, 55, 0.3);
            border-radius: 50%; border-top-color: var(--accent-color);
            animation: spin 1s ease-in-out infinite; margin-bottom: 20px;
        }
        .loader-text { font-family: var(--font-body); font-size: 1.1rem; color: #ccc; animation: pulse 2s infinite; }
        .loader-logs { font-size: 0.8rem; color: #666; margin-top: 15px; font-family: monospace; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse { 50% { opacity: 0.5; } }

        /* --- CONTAINER --- */
        #immersive-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
            opacity: 0; transition: opacity 1s ease;
        }
        #immersive-container.loaded { opacity: 1; }

        /* --- STYLES GALERIE --- */
        .category-slide {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; transform: scale(1.1); pointer-events: none; background: #000;
            transition: transform var(--v-transition), opacity var(--v-transition);
        }
        .category-slide.active { opacity: 1; transform: scale(1); z-index: 2; pointer-events: auto; }
        .category-slide.previous { opacity: 1; z-index: 1; }
        .category-slide.is-leaving { transform: scale(0.95); opacity: 0; }

        .gallery-slide {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; transform: translateX(100px); z-index: 1;
            display: flex; justify-content: center; align-items: center; overflow: hidden;
            transition: transform var(--h-transition), opacity var(--h-transition);
        }
        .gallery-slide.active { opacity: 1; transform: translateX(0); z-index: 2; }
        .gallery-slide.is-leaving-left { transform: translateX(-100px); opacity: 0; }
        .gallery-slide.is-leaving-right { transform: translateX(100px); opacity: 0; }

        /* Modes d'affichage */
        .landscape-mode { background-size: cover; background-position: center; width: 100%; height: 100%; }
        
        .portrait-grid {
            display: flex; flex-direction: row; justify-content: center; align-items: center; gap: 2vw;
            width: 100%; height: 100%; padding: 5%;
            background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
        }
        .portrait-img {
            height: 70vh; width: auto; max-width: 30vw; object-fit: cover;
            border-radius: 4px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transition: transform 0.4s ease;
        }
        .portrait-img:hover { transform: scale(1.05); z-index: 10; }

        /* Textes */
        .category-content {
            position: absolute; bottom: 5%; left: 50%; transform: translateX(-50%);
            z-index: 10; text-align: center; color: white; opacity: 0; pointer-events: none;
            transition: opacity 1s 0.5s ease;
        }
        .category-slide.active .category-content { opacity: 1; }
        .category-title { font-family: var(--font-title); font-size: 4rem; margin-bottom: 0.5rem; text-shadow: 0 5px 15px rgba(0,0,0,0.8); }
        .category-subtitle { font-family: var(--font-body); letter-spacing: 3px; color: var(--accent-color); text-transform: uppercase; }
        .paginator { margin-top:10px; font-size: 1.2rem; }

        /* Navigation */
        .nav-arrow {
            position: fixed; top: 50%; transform: translateY(-50%);
            z-index: 100; font-size: 2.5rem; color: rgba(255,255,255,0.6);
            opacity: 0; cursor: pointer; padding: 15px; border-radius: 50%;
            background: rgba(0,0,0,0.2); transition: 0.3s;
        }
        .nav-arrow:hover { background: rgba(255,255,255,0.2); color: #fff; }
        .nav-arrow.left { left: 30px; }
        .nav-arrow.right { right: 30px; }
        .category-slide.active.has-multiple-slides ~ .nav-arrow { opacity: 1; }
        
        .back-btn { position: fixed; top: 30px; left: 30px; z-index: 200; color: white; text-decoration: none; font-size: 1.2rem; opacity: 0.7; }
        
        .error-msg { color: red; font-size: 1.5rem; text-align: center; margin-top: 20px; }
    </style>
</head>
<body>

    <div id="loader-overlay">
        <div class="loader-spinner"></div>
        <div class="loader-text">Analyse et chargement des photos...</div>
        <div id="loader-logs" class="loader-logs">Connexion au serveur...</div>
    </div>

    <a href="index.html" class="back-btn">← Retour</a>

    <div id="immersive-container"></div>
    
    <div class="nav-arrow left" id="btnLeft">&#10094;</div>
    <div class="nav-arrow right" id="btnRight">&#10095;</div>

    <script>
        const API_URL = ""; // Adresse de ton serveur Node.js

        // Configuration des catégories
        const categoriesConfig = [
            { id: 'voyage', title: 'Voyages', subtitle: 'Exploration' },
            { id: 'evt', title: 'Événements', subtitle: 'Moments Capturés' }
        ];

        const container = document.getElementById('immersive-container');
        const loaderLogs = document.getElementById('loader-logs');
        let generatedCategories = [];

        // Fonction utilitaire pour charger une image et récupérer ses dimensions
        function getImageMeta(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve({ url, width: img.naturalWidth, height: img.naturalHeight, orientation: img.naturalWidth > img.naturalHeight ? 'landscape' : 'portrait' });
                img.onerror = () => { console.warn("Image échec:", url); resolve(null); }; // On ignore les erreurs pour ne pas bloquer
                img.src = url;
            });
        }

        async function initGallery() {
            try {
                for (let catConfig of categoriesConfig) {
                    loaderLogs.textContent = `Récupération dossier : ${catConfig.title}...`;
                    
                    // 1. Demander la liste des fichiers au serveur
                    const res = await fetch(`/api/photos/${catConfig.id}`);
                    if (!res.ok) throw new Error(`Erreur serveur pour ${catConfig.id}`);
                    const data = await res.json();
                    
                    if (!data.images || data.images.length === 0) {
                        console.log(`Aucune image dans ${catConfig.id}`);
                        continue;
                    }

                    // 2. Analyser les images (dimensions) pour le tri
                    loaderLogs.textContent = `Tri automatique : ${catConfig.title} (${data.images.length} photos)...`;
                    
                    const imagePromises = data.images.map(filename => {
                        // On utilise l'URL statique servie par le serveur
                        return getImageMeta(`/assets/${catConfig.id}/${filename}`);
                    });

                    const loadedImages = (await Promise.all(imagePromises)).filter(img => img !== null);

                    // 3. Construire les slides (Logique de tri intelligente)
                    let slides = [];
                    let portraitBuffer = [];

                    loadedImages.forEach((img) => {
                        if (img.orientation === 'landscape') {
                            // Si on a des portraits en attente, on crée d'abord un slide pour eux
                            if (portraitBuffer.length > 0) {
                                slides.push({ type: 'portrait', images: [...portraitBuffer] });
                                portraitBuffer = [];
                            }
                            // Puis on ajoute le paysage
                            slides.push({ type: 'landscape', images: [img] });
                        } else {
                            // C'est un portrait
                            portraitBuffer.push(img);
                            // Si on en a 3, on crée un slide
                            if (portraitBuffer.length >= 3) {
                                slides.push({ type: 'portrait', images: [...portraitBuffer] });
                                portraitBuffer = [];
                            }
                        }
                    });
                    // S'il reste des portraits à la fin
                    if (portraitBuffer.length > 0) {
                        slides.push({ type: 'portrait', images: [...portraitBuffer] });
                    }

                    generatedCategories.push({
                        ...catConfig,
                        slides: slides
                    });
                }

                // 4. Générer le HTML
                renderHTML();

                // 5. Cacher le loader
                loaderLogs.textContent = "Prêt !";
                setTimeout(() => {
                    document.getElementById('loader-overlay').style.opacity = '0';
                    document.getElementById('loader-overlay').style.visibility = 'hidden';
                    container.classList.add('loaded');
                    initNavigation(); // Lancer la logique de navigation
                }, 800);

            } catch (err) {
                console.error(err);
                loaderLogs.textContent = "Erreur : Vérifiez que 'node server.js' est lancé !";
                loaderLogs.style.color = "red";
                document.querySelector('.loader-spinner').style.borderColor = "red";
            }
        }

        function renderHTML() {
            container.innerHTML = '';
            generatedCategories.forEach((cat, index) => {
                const catDiv = document.createElement('div');
                catDiv.className = `category-slide ${index === 0 ? 'active' : ''}`;
                
                cat.slides.forEach((slide, sIndex) => {
                    const slideDiv = document.createElement('div');
                    slideDiv.className = `gallery-slide ${sIndex === 0 ? 'active' : ''}`;
                    
                    if (slide.type === 'landscape') {
                        slideDiv.classList.add('landscape-mode');
                        slideDiv.style.backgroundImage = `url('${slide.images[0].url}')`;
                    } else {
                        const grid = document.createElement('div');
                        grid.className = 'portrait-grid';
                        slide.images.forEach(imgData => {
                            const img = document.createElement('img');
                            img.src = imgData.url;
                            img.className = 'portrait-img';
                            grid.appendChild(img);
                        });
                        slideDiv.appendChild(grid);
                    }
                    catDiv.appendChild(slideDiv);
                });

                // Texte
                const contentDiv = document.createElement('div');
                contentDiv.className = 'category-content';
                contentDiv.innerHTML = `
                    <span class="category-subtitle">${cat.subtitle}</span>
                    <h2 class="category-title">${cat.title}</h2>
                    <p class="paginator"><span class="current">1</span> / <span class="total">${cat.slides.length}</span></p>
                `;
                catDiv.appendChild(contentDiv);
                container.appendChild(catDiv);
            });
        }

        // --- NAVIGATION (Similaire à avant mais adaptée au dynamique) ---
        function initNavigation() {
            const categoriesEls = document.querySelectorAll('.category-slide');
            const btnLeft = document.getElementById('btnLeft');
            const btnRight = document.getElementById('btnRight');
            let categoryIndex = 0;
            let slideIndexes = new Array(categoriesEls.length).fill(0);
            let isAnimating = false;

            function updateUI() {
                btnLeft.style.opacity = '0'; btnRight.style.opacity = '0';
                btnLeft.style.pointerEvents = 'none'; btnRight.style.pointerEvents = 'none';

                categoriesEls.forEach((cat, idx) => {
                    const slides = cat.querySelectorAll('.gallery-slide');
                    const paginatorCurrent = cat.querySelector('.paginator .current');
                    if(paginatorCurrent) paginatorCurrent.textContent = slideIndexes[idx] + 1;

                    if (idx === categoryIndex) {
                        if (slides.length > 1) {
                            cat.classList.add('has-multiple-slides');
                            btnLeft.style.opacity = '1'; btnRight.style.opacity = '1';
                            btnLeft.style.pointerEvents = 'auto'; btnRight.style.pointerEvents = 'auto';
                        }
                    }
                });
            }

            function moveSlide(dir) {
                if (isAnimating) return;
                const cat = categoriesEls[categoryIndex];
                const slides = cat.querySelectorAll('.gallery-slide');
                const current = slideIndexes[categoryIndex];
                let next = current + dir;

                if (next < 0) next = slides.length - 1;
                if (next >= slides.length) next = 0;
                if (next === current) return;

                isAnimating = true;
                slides[current].classList.add(dir > 0 ? 'is-leaving-left' : 'is-leaving-right');
                slides[current].classList.remove('active');
                
                slides[next].classList.add('active');
                slides[next].classList.remove('is-leaving-left', 'is-leaving-right');
                
                slideIndexes[categoryIndex] = next;
                updateUI();
                setTimeout(() => { 
                    slides[current].classList.remove('is-leaving-left', 'is-leaving-right');
                    isAnimating = false; 
                }, 1000);
            }

            function moveCategory(dir) {
                if (isAnimating) return;
                let next = categoryIndex + dir;
                if (next < 0 || next >= categoriesEls.length) return;

                isAnimating = true;
                categoriesEls[categoryIndex].classList.add('previous', 'is-leaving');
                categoriesEls[categoryIndex].classList.remove('active');
                
                categoriesEls[next].classList.add('active');
                categoryIndex = next;
                updateUI();
                setTimeout(() => {
                    categoriesEls[categoryIndex - dir].classList.remove('previous', 'is-leaving');
                    isAnimating = false;
                }, 1200);
            }

            btnLeft.onclick = () => moveSlide(-1);
            btnRight.onclick = () => moveSlide(1);
            
            window.addEventListener('keydown', (e) => {
                if(e.key === 'ArrowRight') moveSlide(1);
                if(e.key === 'ArrowLeft') moveSlide(-1);
                if(e.key === 'ArrowDown') moveCategory(1);
                if(e.key === 'ArrowUp') moveCategory(-1);
            });
            
            window.addEventListener('wheel', (e) => {
                if(isAnimating) return;
                if(Math.abs(e.deltaY) > 20) moveCategory(Math.sign(e.deltaY));
                else if(Math.abs(e.deltaX) > 20) moveSlide(Math.sign(e.deltaX));
            });

            updateUI();
        }

        // Lancement !
        initGallery();

    </script>
</body>
</html>